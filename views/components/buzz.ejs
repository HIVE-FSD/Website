<% function truncateText(text, maxLength) { if (text.length> maxLength) {
    return text.slice(0, maxLength) + ' <span class="more">...more</span>';
    } else {
    return text;
    }
    }
    %>

<% function formatTimeAgo(datetimeString) { 
    const now=new Date(); 
    const commentedOn=new Date(datetimeString); 
    const diffMs=now - commentedOn;
    const diffSeconds=Math.floor(diffMs / 1000);
    const diffMinutes=Math.floor(diffSeconds /60); 
    const diffHours=Math.floor(diffMinutes / 60);
    const diffDays=Math.floor(diffHours / 24); const
    diffYears=Math.floor(diffDays / 365); if (diffYears> 0) {
    return `${diffYears} year${diffYears > 1 ? 's' : ''} ago`;
    } else if (diffDays > 0) {
    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    } else if (diffHours > 0) {
    return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    } else if (diffMinutes > 0) {
    return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
    } else {
    return `${diffSeconds} second${diffSeconds > 1 ? 's' : ''} ago`;
    }
    } %>

<div class="buzz-super">
    <div class="buzz">
        <div class="votes-container">
            <span class="material-symbols-outlined add-vote-btn vote-btn" onclick="addVote(this)">
                expand_less
            </span>
            <span class="votes-value"><%= buzz.votes %></span>
            <span class="material-symbols-outlined remove-vote-btn vote-btn" onclick="removeVote(this)">
                expand_more
            </span>
        </div>
        <span class="material-symbols-outlined buzz-close" onclick="closeContent(this)">close</span>
        <div class="buzz-main">
            <div class="buzz-top">
                <h1>
                    <%= buzz.title %>
                </h1>
                
            </div>
            <p class="buzz-description" onclick="expandContent(this)"><%- truncateText(buzz.content, 75) %></p>
            <div class="buzz-functions">
                <span class="buzz-functions-left">
                    <div>
                        Posted by
                        <%- include('profileCard', { username: buzz.user }) %>
                    </div>
                    <%= formatTimeAgo(buzz.buzzedon) %> at <a href=<%= "/buzzspace/"+buzz.buzzSpace  %>><%= buzz.buzzSpace %></a>
                </span>
                <div class="buzz-inner-functions">
                    <div onclick="toggleCommentArea(this)"><span class="material-symbols-outlined">comment</span> Comment</div>
                    <div><span class="material-symbols-outlined">flag</span> Report</div>
                </div>
            </div>
            <div class="buzz-comment-section">
                <div class="buzz-comment-area" style="display: none;">
                    <textarea class="buzz-commentText" rows="2" cols="50"></textarea>
                    <div class="buzz-comment-btn-container">
                        <button onclick="buzzComment(this)">Comment</button>
                        <button onclick="cancelComment(this)">Cancel</button>
                    </div>
                </div>
                <h3 class="buzz-comment-title" >Comments</h3>
                <ul class="buzz-comments-list">
                    <%- include('buzzComments', { comments: buzz.comments }) %>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    function expandContent(paragraph) {
        const buzzSuper = paragraph.closest('.buzz-super');
        buzzSuper.classList.add('modal');
        paragraph.innerHTML = '<%= buzz.content %>';
    }

    function closeContent(close) {
        const buzzSuper = close.closest('.buzz-super');
        const paragraph = buzzSuper.querySelector('.buzz-description');
        const commentArea = buzzSuper.querySelector('.buzz-comment-area');
        commentArea.style.display = 'none';
        buzzSuper.classList.remove('modal');
        paragraph.innerHTML = '<%- truncateText(buzz.content, 75) %>';
    }

    function toggleCommentArea(commentButton) {
        const buzzSuper = commentButton.closest('.buzz-super');
        const commentArea = buzzSuper.querySelector('.buzz-comment-area');
        commentArea.style.display = 'block';
        expandContent(buzzSuper.querySelector('.buzz-description'));
    }
    function toggleReplyArea(commentButton) {
        const buzzSuper = commentButton.closest('.buzz-comment-main');
        const commentArea = buzzSuper.querySelector('.buzz-comment-area');
        commentArea.style.display = 'block';
        expandContent(buzzSuper.querySelector('.buzz-description'));
    }
</script>

<script src="js/buzz.js"></script>
